# TrustNet-AI – Azure App Service Deployment Plan

## Overview
Deploy two apps to Azure App Service (Linux):
- backend-api: Node.js Express API (port 5000)
- frontend-spa: React (Vite) built to static files and served via `serve`

Shared resources:
- 1 App Service Plan (Linux, B1 or P1v3)
- Application Insights (backend)
- Optional: Azure Key Vault for secrets
- Existing/External: Azure OpenAI service (you provide keys/endpoint)

## Resource Topology
- RG: <provide>
- Region: <provide>
- ASP: asp-trustnet-<env>
- WebApp (API): trustnet-api-<env>
- WebApp (FE): trustnet-web-<env>
- App Insights: appi-trustnet-<env>
- Key Vault (optional): kv-trustnet-<env>

## App Settings

Backend (trustnet-api-<env>):
- PORT=5000
- NODE_ENV=production
- ALLOWED_ORIGINS=https://trustnet-web-<env>.azurewebsites.net,<add-your-custom-domain>
- OPENAI_API_KEY=<from Azure OpenAI>
- AZURE_OPENAI_ENDPOINT=<https://YOUR-RESOURCE.openai.azure.com>
- AZURE_OPENAI_DEPLOYMENT=<your-deployment-name>
- AZURE_OPENAI_API_VERSION=2024-02-01

Frontend (trustnet-web-<env>):
- PORT=3000 (optional; App Service sets PORT automatically)
- VITE_API_URL=https://trustnet-api-<env>.azurewebsites.net/api

## Build & Runtime

Backend:
- Node version: use site setting `WEBSITE_NODE_DEFAULT_VERSION` or Oryx default (Node 18+ recommended)
- Startup command: not required (uses `npm start`)

Frontend:
- Scripts updated to build on install and run with `serve -s dist -l $PORT`
- No custom startup needed; App Service runs `npm start`

## Deployment Options

A) GitHub Actions (recommended)
- Create two workflows deploying to each Web App using publish profile secrets
- Secrets: `AZURE_WEBAPP_PUBLISH_PROFILE_BACKEND`, `AZURE_WEBAPP_PUBLISH_PROFILE_FRONTEND`
- Triggers on push to main

B) Azure Developer CLI (azd)
- Provision resources (App Service plan, apps, App Insights)
- Deploy both apps with `azd deploy`

C) VS Code Azure App Service Deploy
- Manual deploy from workspace for each app

## Provisioning with Azure CLI (one-time)
```bash
# variables
SUB="<subscription-id>"
RG="rg-trustnet-prod"
LOC="eastus"
PLAN="asp-trustnet-prod"
API="trustnet-api-prod"
WEB="trustnet-web-prod"

az account set --subscription $SUB
az group create -n $RG -l $LOC
az appservice plan create -n $PLAN -g $RG --sku B1 --is-linux

# Backend
az webapp create -g $RG -p $PLAN -n $API --runtime "NODE:18-lts"
az monitor app-insights component create -g $RG -l $LOC -a appi-trustnet-prod
INS_KEY=$(az monitor app-insights component show -g $RG -a appi-trustnet-prod --query instrumentationKey -o tsv)
az webapp config appsettings set -g $RG -n $API --settings \
  PORT=5000 NODE_ENV=production APPLICATIONINSIGHTS_CONNECTION_STRING="InstrumentationKey=$INS_KEY"
# Add your OpenAI and CORS settings
az webapp config appsettings set -g $RG -n $API --settings \
  OPENAI_API_KEY="<value>" \
  AZURE_OPENAI_ENDPOINT="<value>" \
  AZURE_OPENAI_DEPLOYMENT="<value>" \
  AZURE_OPENAI_API_VERSION="2024-02-01" \
  ALLOWED_ORIGINS="https://$WEB.azurewebsites.net"

# Frontend
az webapp create -g $RG -p $PLAN -n $WEB --runtime "NODE:18-lts"
az webapp config appsettings set -g $RG -n $WEB --settings \
  VITE_API_URL="https://$API.azurewebsites.net/api"
```

## GitHub Actions – Backend (.github/workflows/deploy-backend.yml)
- Build: `npm ci`
- Deploy: `azure/webapps-deploy@v3` with `publish-profile` from secret
- Working dir: `backend`

## GitHub Actions – Frontend (.github/workflows/deploy-frontend.yml)
- Build: `npm ci && npm run build`
- Deploy: `azure/webapps-deploy@v3` with `publish-profile`
- Working dir: `frontend1`

## Verification
- API health: https://<api-app>.azurewebsites.net/api/health
- API root: https://<api-app>.azurewebsites.net/
- FE home: https://<web-app>.azurewebsites.net/

## Notes
- Point custom domains and enable HTTPS after verification
- Consider Key Vault for secrets and assign managed identity to backend
- Scale up SKU if cold start/throughput requires
